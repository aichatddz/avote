import { sumPoints, BigPoint, BigCipher, Cipher, sumBigPoints, decode, toBigPoint, randomScalar} from "../component/util";
import hre from "hardhat";
import { buildBabyjub, Point, BabyJub } from "circomlibjs";

interface VoterTestValue {
  private: bigint;  // it's not used yet
  value: number;
  randomK: bigint;
  c1: BigPoint;
  c2: BigPoint;
}

interface CounterTestValue {
  private: bigint;
  // public: BigPoint;
  dMulC1: BigPoint;
}

interface TestState {
    candidates: readonly `0x${string}`[];
    voters: readonly `0x${string}`[];
    sponporEthers: bigint;
    state: number;
    counterPublicKeys: readonly BigPoint[];
    ballots: readonly BigCipher[];
    decryptPoints: readonly BigPoint[];
    expiredBlock: bigint;
    sumPublicKey: BigPoint;
    sumVotes: BigCipher;
}

var testCandidates: readonly `0x${string}`[] = [
  '0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc',
  '0x976EA74026E726554dB657fA54763abd0C3a0aa9',
  '0x14dC79964da2C08b23698B3D3cc7Ca32193d9955',
  '0x23618e81E3f5cdF7f54C3d65f7FBc0aBf5B21E8f',
  '0xa0Ee7A142d267C1f36714E4a8F75612F20a79720'
]

var testVoters: readonly `0x${string}`[] = [
  "0xBcd4042DE499D14e55001CcbB24a551F3b954096",
  "0x71bE63f3384f5fb98995898A86B02Fb2426c5788",
  "0xFABB0ac9d68B0B445fB7357272Ff202C5651694a",
  "0x1CBd3b2770909D4e10f157cABC84C7264073C9Ec",
  "0xdF3e18d64BC6A983f673Ab319CCaE4f1a57C7097"
]

var testCounterPublicKeys: readonly BigPoint[] = [{
      x: 12850997157950850405723489739354319047062600787099111201744321248306482255143n,
      y: 14743751048901513658331640233977231163182936175196280839934763098776720590409n
  },{
      x: 5545411705471143187699633907300542638207246452368574276711215960752437953732n,
      y: 16565961326947122016967754573301214999120716741052680976847987077769175046719n
  },{
      x: 19379458244332873934242360953958021443826696883006783546738195684145713708094n,
      y: 10060294436525543204611718053921107805932965241803516374071343926591655898063n
}]

var testSumPublicKeys: BigPoint = {
  x: 17562281052541849814619194517171420429774894242466780171322661757215271005933n,
  y: 5545643084915208416594058274347129551972220545965249783234145634433536213542n,
}

var testBallots: BigCipher[] = [
  {
      c1: {
        x: 4927186078240140046265353961886559884626197109666961159300140392289670006231n,
        y: 8020290187704485342258828070343193949044353401393013934184033625253291783851n,
      },
      c2: {
        x: 5095231844120880793323863218492658424924250123359868729330699495771584066623n,
        y: 18814646589350445839362184305043626641028853182367201556837650789424538027246n,
      }
  },
  {
      c1: {
        x: 5950138701138748602872839146346803612147640892285571687315568280501474776667n,
        y: 19801382270819322338371924741668328091603279883798289397156548146655634279043n,
      },
      c2: {
        x: 19551798702234497938852910329658283315281403366597685922309994172137949210470n,
        y: 9589002976014871039477560575267955571838388695098661656083909249518179935423n,
      },
  },
  {
      c1: {
        x: 3547530953419371257734676976196493220667798891270180410274053106392379699126n,
        y: 2857669480309460825166048718616540765211657179603511183626401637573573564946n,
      },
      c2: {
        x: 14840281706620884291616083736499460613754174344028022110529763243226189716967n,
        y: 8110729206842040793978065050878728181007374289365506282021599459075923132902n,
      }
  },
  {
      c1: {
        x: 4187293818286361699895632992775746231568694846289580904069535219438641015339n,
        y: 17641463013099135835269526991334333119632839997477541661000959287658836165613n,
      },
      c2: {
        x: 4316987542220216246928612834392827007342442537462770867984146788137032993646n,
        y: 7100926374345897409515537554400069511635449901388748984630740068262828595085n,
      }
  },
  {
      c1: {
        x: 1972411620866860113407425005248654798556739856996899136222612442639314288355n,
        y: 1373356950687444176160227572558197519787106187137745243099578692387192387536n,
      },
      c2: {
        x: 8264426594767412502559006948788934129853133604300385464975597675885461845939n,
        y: 690409446320898477308298715348859559171807148545752497181437933949644695629n,
      }
  }
]

var testSumBallots: BigCipher = {
  c1: {
    x: 4581260430175070783408571085641532620249784736829700533832715250107242346585n,
    y: 14882391343821010434428845766509207672190941494785204334611706690448955976844n,
  },
  c2: {
    x: 8331369744015922138462484517269120738268013900871287974180609798583516246958n,
    y: 10188787274520102679995611343114671845066683377365217292362416829258517313708n,
  }
}

var testDecryptPoints: BigPoint[] = [{
    x: 17586405391974699223143074723589877012749432494028331276422099265030666348654n,
    y: 16437489348796400388617656096621684919302650347297451868090043575543022655568n,
  },{
    x:21084389068483219027875384063746789633976695523374699817104638034976281328947n,
    y:2508542504771750605747188674486627963376873373636006411342463972362506706028n,
  },{
    x: 17450306543244095259989696499644199062146864895587615636847394954930251920914n,
    y: 1247813636160191280768694652694491180916599064873943164580769409637792978872n,
  },
]

const zeroPoint: BigPoint = {x: 0n, y: 1n};

export function InitiatedStateStart(): TestState {
  return {
      candidates: testCandidates,
      voters: testVoters,
      sponporEthers: 1n,
      state: 1,
      counterPublicKeys: [],
      ballots: [],
      decryptPoints: [],
      expiredBlock: 11n,
      sumPublicKey: zeroPoint,
      sumVotes: {c1: zeroPoint, c2: zeroPoint},
  };
}

export function InitiatedStateEnd(): TestState {
  return {
      candidates: testCandidates,
      voters: testVoters,
      sponporEthers: 1n,
      state: 1,
      counterPublicKeys: testCounterPublicKeys,
      ballots: [],
      decryptPoints: [],
      expiredBlock: 11n,
      sumPublicKey: zeroPoint,
      sumVotes: {c1: zeroPoint, c2: zeroPoint},
  };
}

export function VotingStateStart(): TestState {
  return {
      candidates: testCandidates,
      voters: testVoters,
      sponporEthers: 1n,
      state: 2,
      counterPublicKeys: testCounterPublicKeys,
      ballots: [],
      decryptPoints: [],
      expiredBlock: 11n,
      sumPublicKey: testSumPublicKeys,
      sumVotes: {c1: zeroPoint, c2: zeroPoint},
  };
}

export function VotingStateEnd(): TestState {
  return {
      candidates: testCandidates,
      voters: testVoters,
      sponporEthers: 1n,
      state: 2,
      counterPublicKeys: testCounterPublicKeys,
      ballots: testBallots,
      decryptPoints: [],
      expiredBlock: 11n,
      sumPublicKey: testSumPublicKeys,
      sumVotes: {c1: zeroPoint, c2: zeroPoint},
  };
}

export function TallyingStateStart(): TestState {
  return {
      candidates: testCandidates,
      voters: testVoters,
      sponporEthers: 1n,
      state: 3,
      counterPublicKeys: testCounterPublicKeys,
      ballots: testBallots,
      decryptPoints: [],
      expiredBlock: 11n,
      sumPublicKey: testSumPublicKeys,
      sumVotes: testSumBallots,
  };
}

export function TallyingStateEnd(): TestState {
  return {
      candidates: testCandidates,
      voters: testVoters,
      sponporEthers: 1n,
      state: 3,
      counterPublicKeys: testCounterPublicKeys,
      ballots: testBallots,
      decryptPoints: testDecryptPoints,
      expiredBlock: 11n,
      sumPublicKey: testSumPublicKeys,
      sumVotes: testSumBallots,
  };
}

export async function deployFixture() {
    // Contracts are deployed using the first signer/account by default
    const accounts = await hre.viem.getWalletClients();
 
    const voteVerifier = await hre.viem.deployContract("contracts/circuit/vote_verifier.sol:Groth16Verifier", [], {});
    const publicKeyVerifier = await hre.viem.deployContract("contracts/circuit/publickey_verifier.sol:Groth16Verifier", [], {});
    const decryptVerifier = await hre.viem.deployContract("contracts/circuit/decrypt_verifier.sol:Groth16Verifier", [], {});
    const avote = await hre.viem.deployContract("AvoteForTest", [voteVerifier.address, publicKeyVerifier.address, decryptVerifier.address], {});

    const publicClient = await hre.viem.getPublicClient();
    const curve = await buildBabyjub();

    for (let i = 1; i <= 3; i++) {
      await avote.write.AddCounter([accounts[i].account.address]);
    }

    const counterTestValues: CounterTestValue[] = [
      {
        private: 735514173037608534735104653239571788205806618835123745487136276835914656619n,
        dMulC1: {
          x: 17586405391974699223143074723589877012749432494028331276422099265030666348654n,
          y: 16437489348796400388617656096621684919302650347297451868090043575543022655568n,
        }
      },
      {
        private: 632366879893181405087379695101455452961379375663675034682573978561129264084n,
        dMulC1: {
          x:21084389068483219027875384063746789633976695523374699817104638034976281328947n,
          y:2508542504771750605747188674486627963376873373636006411342463972362506706028n,
        }
      },
      {
        private: 2309680827062359428527157418503620910777834679952307807722172278573486636784n,
        dMulC1: {
          x: 17450306543244095259989696499644199062146864895587615636847394954930251920914n,
          y: 1247813636160191280768694652694491180916599064873943164580769409637792978872n,
        }
      },
    ]

    const voterPrivates: VoterTestValue[] = [
      {
        private: 2230359128765178667009492279002232690348502915904860098119029361924741268331n, 
        value: 1, 
        randomK: 1186514429774673263045386838204114554872366147750302254896049112187317603883n,
        c1: {
          x: 4927186078240140046265353961886559884626197109666961159300140392289670006231n, 
          y: 8020290187704485342258828070343193949044353401393013934184033625253291783851n,
        },
        c2: {
          x: 5095231844120880793323863218492658424924250123359868729330699495771584066623n, 
          y: 18814646589350445839362184305043626641028853182367201556837650789424538027246n,
        }
      },
      {
        private: 2307068043429434355608527159120511283714965558313529488750141847727947338047n, 
        value: 2, 
        randomK: 2304228914364770495375489776807601134895615849297190862334840635916175840578n,
        c1: {
          x: 5950138701138748602872839146346803612147640892285571687315568280501474776667n, 
          y: 19801382270819322338371924741668328091603279883798289397156548146655634279043n,
        },
        c2: {
          x: 19551798702234497938852910329658283315281403366597685922309994172137949210470n, 
          y: 9589002976014871039477560575267955571838388695098661656083909249518179935423n,
        }
      },
      {
        private: 169597424537300259879951871106718979281962930472519670071286047737098634808n, 
        value: 3,
        randomK: 1733110834937671739964741288065960546195549429679506389541532944902961390217n,
        c1: {
          x: 3547530953419371257734676976196493220667798891270180410274053106392379699126n, 
          y: 2857669480309460825166048718616540765211657179603511183626401637573573564946n,
        },
        c2: {
          x: 14840281706620884291616083736499460613754174344028022110529763243226189716967n, 
          y: 8110729206842040793978065050878728181007374289365506282021599459075923132902n,
        }
      },
      {
        private: 475544391661551677346151511013601989982873960504037718549505370862099543606n, 
        value: 1, 
        randomK:  1464192984160956163854823254075844836430673130662993778972848362882461520655n,
        c1: {
          x: 4187293818286361699895632992775746231568694846289580904069535219438641015339n, 
          y: 17641463013099135835269526991334333119632839997477541661000959287658836165613n,
        },
        c2: {
          x: 4316987542220216246928612834392827007342442537462770867984146788137032993646n, 
          y: 7100926374345897409515537554400069511635449901388748984630740068262828595085n,
        }
      },
      {
        private: 546372505267749274698143840508932057256023889190772591914061187395605296852n, 
        value: 1, 
        randomK: 842073200858079431488570481041966272275065633623425498337949642654812475648n,
        c1: {
          x: 1972411620866860113407425005248654798556739856996899136222612442639314288355n, 
          y: 1373356950687444176160227572558197519787106187137745243099578692387192387536n,
        },
        c2: {
          x: 8264426594767412502559006948788934129853133604300385464975597675885461845939n, 
          y: 690409446320898477308298715348859559171807148545752497181437933949644695629n,
        }
      }
    ]
    const expectPublicKey: Point = [
      curve.F.e(17562281052541849814619194517171420429774894242466780171322661757215271005933n.toString()),
      curve.F.e(5545643084915208416594058274347129551972220545965249783234145634433536213542n.toString()),
    ];

    const sumCipher: Cipher = {
      c1: [curve.F.e(4581260430175070783408571085641532620249784736829700533832715250107242346585n.toString()), curve.F.e(14882391343821010434428845766509207672190941494785204334611706690448955976844n.toString())],
      c2: [curve.F.e(8331369744015922138462484517269120738268013900871287974180609798583516246958n.toString()), curve.F.e(10188787274520102679995611343114671845066683377365217292362416829258517313708n.toString())],
    }

    const sumDecrypts: BigPoint = {
      x: 1617871771995441095161541924150672646449831557532794326082971468472488563059n,
      y: 2084097603320654059057452933899276738950979811550339513244161863208586951653n,
    }

    const voteId = randomScalar(curve);
    // console.log(voteId);

    return { curve, avote, counterTestValues, voterPrivates, expectPublicKey, sumCipher, sumDecrypts, voteId, accounts, publicClient };
  }

